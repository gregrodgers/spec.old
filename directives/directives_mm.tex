\section{Memory Management Directives}
\label{sec:Memory Management Directives}
\index{memory management}
\index{directives!memory management directives}
\index{memory management directives!memory management directives}

\subsection{\code{declare alloc} Directive}
\index{declare alloc@{\code{declare alloc}}}
\index{directives!declare@{\code{declare alloc}}}
\label{subsec:declare alloc Directive}

\summary

\syntax

\description

\subsection{\code{allocate} Directive}
\index{allocate@{\code{allocate}}}
\index{directives!allocate@{\code{allocate}}}
\label{subsec:allocate Directive}
\summary
 
The \code{allocate} directive specifies how a set of variables are allocated. 
\ccppspecificstart
The \code{allocate} directive is a declarative directive.
\ccppspecificend
\fortranspecificstart
The \code{allocate} directive is a declarative directive if it is not associated with an \code{allocate} statement.
\fortranspecificend
 
\syntax
\ccppspecificstart
The syntax of the \code{allocate} directive is as follows:

\begin{boxedcode}
\#pragma omp allocate(\plc{list}) \plc{[clause[ [ [},\plc{] clause] ... ]] new-line}
\end{boxedcode}

\needspace{10\baselineskip}
where \plc{clause} is one of the following:

\begin{indentedcodelist}
allocator(\plc{allocator})
memspace(\plc{memspace})
alloctraits(\plc{alloctrait-list})
memtraits(\plc{memtrait-list})
safe_align(\plc{alignment})
\end{indentedcodelist}

where \plc{allocator} is an expression of the \code{omp\_allocator\_t} type.

where \plc{memspace} is an expression of the \code{omp\_memspace\_t} type.

where \plc{alloctrait-list} is a \plc{key-value list} where the allowed keys are the allocator traits keys and the allowed values are the accepted values for each key.

where \plc{memtrait-list} is a \plc{key-value list} where the allowed keys are the memory traits keys and the allowed values are the accepted values for each key.

where \plc{alignment} is an integer expression that must evaluate to a power of two.

\ccppspecificend
\medskip

\fortranspecificstart
The syntax of the \code{allocate} directive is as follows:

\begin{boxedcode}
!\$omp allocate(\plc{list}) \plc{[clause[ [ [},\plc{] clause] ... ]]}
\end{boxedcode}

or
\begin{boxedcode}
!\$omp allocate[(\plc{list})] \plc{clause[ [ [},\plc{] clause] ... ]}
   \plc{allocate statement}
\end{boxedcode}

where \plc{clause} is one of the following:

\begin{indentedcodelist}
allocator(\plc{allocator})
memspace(\plc{memspace})
alloctraits(\plc{alloctrait-list})
memtraits(\plc{memtrait-list})
safe_align(\plc{alignment})
\end{indentedcodelist}

where \plc{allocator} is an integer expression of the \code{omp\_allocator\_kind} \plc{kind}.

where \plc{memspace} is an integer expression of the \code{omp\_memspace\_kind} \plc{kind}.

where \plc{alloctrait-list} is a \plc{key-value list} where the allowed keys are the allocator traits keys and the allowed values are the accepted values for each key.

where \plc{memtrait-list} is a \plc{key-value list} where the allowed keys are the memory traits keys and the allowed values are the accepted values for each key.

where \plc{alignment} is an integer expression that must evaluate to a power of two.

\fortranspecificend

\descr

If the directive is not associated with a Fortran \code{allocate} statement, the storage for each \plc{list item} that appears in the directive will be provided by an allocation through an allocator. If no clause is specified then the allocator specified by the \plc{def-allocator-var} ICV will be used. If the \plc{allocator} clause is specified, the allocator specified in the clause will be used. Otherwise, the allocation will be provided as if using an allocator that had been built with the specified allocator traits, memory traits and/or the \plc{memspace} memory space. If the \code{safe\_align} clause is specified, then the allocation alignment of the request will the value of the \code{safe\_align} clause.

The scope of this allocation is that of the list item in the base language. When the allocation reaches the end of the scope it will be deallocated through the specified allocator or as if using an allocator that had been built with the specified allocator traits, memory traits and/or the \plc{memspace} memory space. If the execution leaves the scope in a manner not supported by the base language it is unspecified whether the deallocation happens or not.

\fortranspecificstart
If the directive is associated with a Fortran \code{allocate} statement, the allocation of the specified list items will be provided through an allocator. If no clause is specified then the allocator specified by the \plc{def-allocator-var} ICV will be used. If the \plc{allocator} clause is specified, the allocator specified in the clause will be used. Otherwise, the allocation will be provided as if using an allocator that had been built with the specified allocator traits, memory traits and/or the \plc{memspace} memory space. If no list item is specified then all variables allocated by the \code{allocate} statement will be provided by the allocator.
\fortranspecificend

For allocations that arise from this directive the \code{null\_fb} value of the \code{fallback} allocator trait will behave as if the \code{abort\_fb} had been specified.

\restrictions
\begin{itemize}
\item A variable that is part of another variable (as an array or structure element) cannot appear in an \code{allocate} directive.
\item The directive must appear in the same scope of the \plc{list item} declaration and before its first use.
\item If the \code{allocator} clause is present, no other clause must be specified.
\item If the \code{allocator} clause is present, the \plc{allocator} must be an allocator returned by the \code{omp\_init\_allocator} routine.
\item At most one \code{allocator} clause can appear on the \code{allocate} directive.
\item If the \code{memspace} clause is present, the  \code{memtraits} clause must not be specified.
\item If the \code{memspace} clause is present, the \plc{memspace} must be a memory space returned by the \code{omp\_init\_memspace} routine.
\item At most one \code{memspace} clause can appear on the \code{allocate} directive.
\item If the \code{safe\_align} clause is present, its value must a power of two.
\ccppspecificstart
\item If a list item has a static storage type, the \code{allocator} and the \code{memspace} clauses must not be specified.
\item If a list item has a static storage type, the \code{fallback} allocator trait must not have the \code{allocator\_fb} value.
\ccppspecificend
\fortranspecificstart
\item List items specified in the \code{allocate} directive must not have the \code{ALLOCATABLE} attribute unless the directive is associated with an \code{allocate} statement.
\item List items specified in an \code{allocate} directive that is associated with an \code{allocate} statement must be \code{ALLOCATABLE} variables allocated by the \code{allocate} statement.
\fortranspecificend
\end{itemize}

\crossreferences
\begin{itemize}
\item Memory spaces, allocators and their traits, see \specref{sec:Memory allocation}.
\ccppspecificstart
\item \code{omp\_memspace\_t} and \code{omp\_allocator\_t}, see \specref{subsec:Memory Management Types}.
\ccppspecificend
\fortranspecificstart
\item \code{omp\_memspace\_kind} and \code{omp\_allocator\_kind}, see \specref{subsec:Memory Management Types}.
\fortranspecificend
\end{itemize}

\subsection{The \code{deallocate} Directive}
\index{deallocate@{\code{deallocate}}}
\index{directives!deallocate@{\code{deallocate}}}
\label{subsec:deallocate Directive}
\summary

\syntax

\description


\subsection{The \code{allocate} Clause}
\index{allocate@{\code{allocate}}}
\index{clauses!allocate@{\code{allocate}}}
\label{subsec:allocate Clause}
\summary
The \code{allocate} clause specifies the allocation and memory traits of the storage used for private variables of a directive.

\syntax

The syntax of the \code{allocate} clause is as follows:

\begin{boxedcode}
allocate(\plc{[modifiers}:\plc{] list})
\end{boxedcode}
\needspace{10\baselineskip}
where \plc{modifiers} is a comma separated list of one or more of the following:

\begin{indentedcodelist}
allocator(\plc{allocator})
memspace(\plc{memspace})
alloctraits(\plc{alloctrait-list})
memtraits(\plc{memtrait-list})
safe_align(\plc{alignment})
\end{indentedcodelist}

\ccppspecificstart
where \plc{allocator} is an integer expression of the \code{omp\_allocator\_t} type.

where \plc{memspace} is an integer expression of the \code{omp\_memspace\_t} type.
\ccppspecificend
\fortranspecificstart
where \plc{allocator} is an integer expression of the \code{omp\_allocator\_kind} \plc{kind}.

where \plc{memspace} is an integer expression of the \code{omp\_memspace\_kind} \plc{kind}.
\fortranspecificend

where \plc{alloctrait-list} is a \plc{key-value list} where the allowed keys are the allocator traits keys and the allowed values are the accepted values for each key.

where \plc{memtrait-list} is a \plc{key-value list} where the allowed keys are the memory traits keys and the allowed values are the accepted values for each key.

where \plc{alignment} is an integer expression that must evaluate to a power of two.
\descr

The storage for new list items that arise from \plc{list item} that appear in the directive will be provided by an allocation through an allocator. If no modifier is specified then the allocator specified by the \plc{def-allocator-var} ICV will be used. If the \plc{allocator} modifier is specified, the allocator specified in the clause will be used. Otherwise, the allocation will be provided as if using an allocator that had been built with the specified allocator traits, memory traits and/or the \plc{memspace} memory space. For allocations that arise from this clause the \code{null\_fb} value of the \code{fallback} allocator trait will behave as if the \code{abort\_fb} had been specified. If the \code{safe\_align} modifier is specified, then the allocation alignment of the request will be the value of the \code{safe\_align} modifier.

\restrictions
\begin{itemize}
\item List items specified in the \code{allocate} clause must also be specified in a \code{private}, \code{firstprivate}, \code{lastprivate}, \code{linear} or 
      \code{reduction} clause in the same directive.
\item If the \code{allocator} modifier is present, no other modifier must be specified.
\item If the \code{allocator} modifier is present, the \plc{allocator} must be an allocator returned by the \code{omp\_init\_allocator} routine.
\item At most one \code{allocator} modifier can appear on the \code{allocate} clause.
\item If the \code{memspace} modifier is present, the  \code{memtraits} modifier must not be specified.
\item If the \code{memspace} modifier is present, the \plc{memspace} must be a memory space returned by the \code{omp\_init\_memspace} routine.
\item At most one \code{memspace} modifier can appear on the \code{allocate} modifier.
\end{itemize}

\crossreferences
\begin{itemize}
\item Memory spaces, allocators and their traits, see \specref{sec:Memory allocation}.
\ccppspecificstart
\item \code{omp\_memspace\_t} and \code{omp\_allocator\_t}, see \specref{subsec:Memory Management Types}.
\ccppspecificend
\fortranspecificstart
\item \code{omp\_memspace\_kind} and \code{omp\_allocator\_kind}, see \specref{subsec:Memory Management Types}.
\fortranspecificend
\end{itemize}