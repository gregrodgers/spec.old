\subsection{Runtime Entry Points for OMPD}
\label{subsec:runtime-entry-points-for-ompd}

Supporting OMPD introduces some requirements of the OpenMP 
runtime
that
fall into three categories: determinging entry points in the user's code that
an OpenMP program can call; exposing locations in the OpenMP runtime through
which control must pass when specific events occur; and providing data that must
be accessible to the tool.


The OpenMP runtime must define a number of entry point symbols
through which execution must pass when particular events occur
\emph{and} data collection for OMPD is enabled.

A tool can gain notification of the event by setting 
a breakpoint at the address of the entry point symbol.

\restrictions

Entry point symbols have external \code{C} linkage and no
demangling or other transformations are required by a tool
to look up its address in the OpenMP program.

Conceptually, an entry point symbol has a function type signature.
However, it does not need to be a function, but rather can be a labeled location
in the runtime code.




\subsubsection{Beginning Parallel Regions}
\label{subsubsec:ompd_bp_parallel_begin}
\index{ompd_bp_parallel_begin@{\code{ompd_bp_parallel_begin}}}

\summary
The OpenMP runtime must execute 
\code{ompd_bp_parallel_begin} when a new parallel region is launched.

\format
\begin{cspecific}
\begin{ompSyntax}
void ompd_bp_parallel_begin ( void );
\end{ompSyntax}
\end{cspecific}


\descr

When starting a new parallel region, the runtime must 
execute \code{ompd_bp_parallel_begin}.
This should occur after a task encounters a parallel construct,
but before any implicit task starts to execute the parallel
region's work.


The execution of \code{ompd_bp_parallel_begin}
occurs once per region, rather than once for each thread per region.

At the point where the runtime reaches \code{ompd_bp_parallel_begin},
a tool can map the encountering native thread to an OpenMP
thread handle using
\code{ompd_get_thread_handle}.
At this point the handle returned by \code{ompd_get_current_parallel_handle}
is that of the new parallel region.
The tool can find the entry point of the user code that
the new parallel region will execute by passing the parallel handle region
to \code{ompd_get_parallel_function}.

The number of threads participating in the parallel region is provided by
the internal variable \plc{ompd-team-size-var} from \code{ompd_get_icv_from_scope}.

The task handle returned by
\code{ompd_get_current_task_handle}
will be that of the task encountering the parallel construct.

The `reenter runtime' address in the information returned by
\code{ompd_get_task_frame}
will be that of the stack frame where the thread called the OpenMP
runtime to handle the parallel construct.
The `exit runtime' address will be for the stack frame where the thread
left the OpenMP runtime to execute the user code that encountered
the parallel construct.


\crossreferences

\begin{itemize}
\item
  \code{ompd_get_thread_handle}, \specref{subsubsubsec:ompd_get_thread_handle}
\item
  \code{ompd_get_current_parallel_handle}, \specref{subsubsubsec:ompd_get_current_parallel_handle}
\item
  \code{ompd_get_current_task_handle}, \specref{subsubsubsec:ompd_get_current_task_handle}
\item
  \code{ompd_get_task_function}, \specref{subsubsubsec:ompd_get_task_function}
\item
  \code{ompd_get_task_frame}, \specref{subsubsubsec:ompd_get_task_frame}
\item \code{ompd_get_icv_from_scope} call, see 
  \specref{subsubsubsec:ompd_get_icv_from_scope}.
\end{itemize}





\subsubsection{Ending Parallel Regions}
\label{subsubsec:ompd_bp_parallel_end}
\index{ompd_bp_parallel_end@{\code{ompd_bp_parallel_end}}}

The OpenMP runtime must execute 
\code{ompd_bp_parallel_end}
when a parallel region ends.

\format
\begin{cspecific}
\begin{ompSyntax}
void ompd_bp_parallel_end ( void );
\end{ompSyntax}
\end{cspecific}


\descr

When a parallel region finishes, the OpenMP runtime must 
execute \code{ompd_bp_parallel_end}.

Control passes through \code{ompd_bp_parallel_end}
once per region, rather than once for each thread per region.

At the point the runtime reaches \code{ompd_bp_parallel_end}
the tool can map the encountering native thread
to an OpenMP thread handle using \code{ompd_get_thread_handle}.
\code{ompd_get_current_parallel_handle}
returns the handle of the terminating parallel region.

\code{ompd_get_current_task_handle}
returns the handle of the task that encountered the
parallel construct that initiated the parallel region just
terminating.
The `reenter runtime' address in the frame information returned by
\code{ompd_get_task_frame}
will be that for the stack frame in which the thread called the
OpenMP runtime to start the parallel construct just terminating.
The `exit runtime' address will refer to the stack frame where the
thread left the OpenMP runtime to execute the user code that
invoked the parallel construct just terminating.

After 
executing \code{ompd_bp_parallel_end}, any \plc{parallel_handle} acquired for this
parallel region is invalid and should be released.


\crossreferences
\begin{itemize}
\item
  \code{ompd_get_thread_handle}, \specref{subsubsubsec:ompd_get_thread_handle}
\item
  \code{ompd_get_current_parallel_handle}, \specref{subsubsubsec:ompd_get_current_parallel_handle}
\item
  \code{ompd_get_current_task_handle}, \specref{subsubsubsec:ompd_get_current_task_handle}
\item
  \code{ompd_get_task_frame}, \specref{subsubsubsec:ompd_get_task_frame}
\end{itemize}






\subsubsection{Beginning Task Regions}
\label{subsubsec:ompd_bp_task_begin}
\index{ompd_bp_task_begin@{\code{ompd_bp_task_begin}}}

The OpenMP runtime must execute 
\code{ompd_bp_task_begin} when a new task is started.


\format
\begin{cspecific}
\begin{ompSyntax}
void ompd_bp_task_begin ( void );
\end{ompSyntax}
\end{cspecific}


\descr

When starting a new task region, the OpenMP runtime system
execute \code{ompd_bp_task_begin}.

The OpenMP runtime system will execute through this location after the task
construct is encountered, but before the new explicit task starts.
At the point where the runtime reaches \code{ompd_bp_task_begin}
the tool can map the native thread to an OpenMP handle using
\code{ompd_get_thread_handle}.

\code{ompd_get_current_task_handle} returns the handle of the new task region.
The entry point of the user code to be executed by the new task
is returned from
\code{ompd_get_task_function}.


\crossreferences
\begin{itemize}
\item
  \code{ompd_get_thread_handle}, \specref{subsubsubsec:ompd_get_thread_handle}
\item
  \code{ompd_get_current_task_handle}, \specref{subsubsubsec:ompd_get_current_task_handle}
\item
  \code{ompd_get_task_function}, \specref{subsubsubsec:ompd_get_task_function}
\end{itemize}





\subsubsection{Ending Task Regions}
\label{subsubsec:ompd_bp_task_end}
\index{ompd_bp_task_end@{\code{ompd_bp_task_end}}}

\summary
The OpenMP runtime must execute 
\code{ompd_bp_task_end}
when a task region ends.


\format
\begin{cspecific}
\begin{ompSyntax}
void ompd_bp_task_end ( void );
\end{ompSyntax}
\end{cspecific}


\descr

When a task region completes, the OpenMP runtime system
execute \code{ompd_bp_task_end}.

At the point where the runtime reaches \code{ompd_bp_task_end}
the tool can use
\code{ompd_get_thread_handle}
to map the encountering native thread to the corresponding
OpenMP thread handle.
At this point \code{ompd_get_current_task_handle}
returns the handle for the terminating task.

After 
executing \code{ompd_bp_task_end}, any \plc{task_handle} acquired for this
task region is invalid and should be released.


\crossreferences
\begin{itemize}
\item
  \code{ompd_get_thread_handle}, \specref{subsubsubsec:ompd_get_thread_handle}
\item
  \code{ompd_get_current_task_handle}, \specref{subsubsubsec:ompd_get_current_task_handle}
\end{itemize}

\subsubsection{Beginning OpenMP Thread}
\label{subsubsec:ompd_bp_thread_begin}
\index{ompd_bp_thread_begin@{\code{ompd_bp_thread_begin}}}

\summary
The OpenMP runtime must execute 
\code{ompd_bp_thread_begin} at the \plc{native-thread-begin} and the \plc{initial-thread-begin} event.


\format
\begin{cspecific}
\begin{ompSyntax}
void ompd_bp_thread_begin ( void );
\end{ompSyntax}
\end{cspecific}


\descr

When starting an OpenMP thread, the runtime must 
\code{ompd_bp_thread_begin}.
This should occur before the thread starts the execution of an
OpenMP region.

\subsubsection{Ending OpenMP Thread}
\label{subsubsec:ompd_bp_thread_begin}
\index{ompd_bp_thread_end@{\code{ompd_bp_thread_end}}}

\summary
The OpenMP runtime must execute 
\code{ompd_bp_thread_end} at the \plc{native-thread-end} and the \plc{initial-thread-end} event.


\format
\begin{cspecific}
\begin{ompSyntax}
void ompd_bp_thread_end ( void );
\end{ompSyntax}
\end{cspecific}


\descr

When terminating an OpenMP thread, the runtime must 
execute \code{ompd_bp_thread_end}.
This should occur after the thread completes the execution of an OpenMP region.

After 
executing \code{ompd_bp_thread_end}, any \plc{thread_handle} acquired for this thread 
is invalid and should be released.


\crossreferences
\begin{itemize}
\item
  \code{ompd_get_thread_handle}, \specref{subsubsubsec:ompd_get_thread_handle}
\end{itemize}






\subsubsection{Beginning OpenMP Device}
\label{subsubsec:ompd_bp_device_begin}
\index{ompd_bp_device_begin@{\code{ompd_bp_device_begin}}}

\summary
The OpenMP runtime must execute 
\code{ompd_bp_device_begin} at the \plc{device-initialize} event.


\format
\begin{cspecific}
\begin{ompSyntax}
void ompd_bp_device_begin ( void );
\end{ompSyntax}
\end{cspecific}


\descr

When initializing a device for executing a target region, the runtime must 
execute \code{ompd_bp_device_begin}.
This should occur before any OpenMP region's work executes on the device.






\subsubsection{Ending OpenMP Device}
\label{subsubsec:ompd_bp_device_end}
\index{ompd_bp_device_end@{\code{ompd_bp_device_end}}}

\summary
The OpenMP runtime must execute 
\code{ompd_bp_device_end} at the \plc{device-finalize} event.


\format
\begin{cspecific}
\begin{ompSyntax}
void ompd_bp_device_end ( void );
\end{ompSyntax}
\end{cspecific}


\descr

When terminating an OpenMP thread, the runtime must 
execute \code{ompd_bp_device_end}.
This should occur after the thread executes any OpenMP region.

After 
executing \code{ompd_bp_device_end}, any \plc{address_space_handle} acquired for this
device is invalid and should be released.

